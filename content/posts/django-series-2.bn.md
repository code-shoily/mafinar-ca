---
title: "ржЬрзНржпрж╛ржВржЧрзЛ ржЕрзНржпрж╛ржбржорж┐ржи ржХрзБржЗржЬ рзи ржПрж░ рж╕ржорж╛ржзрж╛ржи"
date: 2018-06-01T02:00:13-04:00
draft: false
description: "ржЬрзНржпрж╛ржЩрзНржЧрзЛ рж╕рж┐рж░рж┐ржЬрзЗрж░ ржПржЗ ржжрзНржмрж┐рждрзАрзЯ ржкрж░рзНржмрзЗ ржУржЖрж░ржПржорзЗрж░ ржХрж┐ржЫрзБ ржЕрзНржпрж╛ржбржнрж╛ржирзНрж╕ ржмрж┐рж╖рзЯ (ржпрзЗржоржи OuterRef ржУ Subquery) ржирж┐рзЯрзЗ ржХржерж╛ рж╣рзЯрзЗржЫрзЗред"
tags: ["Django", "Admin", "ORM"]
---
ржХрж┐ржЫрзБржжрж┐ржи ржЖржЧрзЗ ржЖрж░рзЗржХржЯрж┐ ржкрзЛрж╕рзНржЯ ржжрж┐рзЯрзЗржЫрж┐рж▓рж╛ржо ржкрж╛ржЗржержи ржмрж╛ржВрж▓рж╛ржжрзЗрж╢ ржЧрзНрж░рзБржкрзЗред ржПржмрж╛рж░ рж╕ржорж╛ржзрж╛ржирзЗрж░ ржкрж╛рж▓рж╛ред ржкрзНрж░ржержорзЗржЗ рж╕рзНржХрзНрж░рж┐ржирж╢ржЯ ржжрзЗрзЯрж╛ ржпрж╛ржХ (ржпрж╛рждрзЗ рзз, ржЖржорж╛рж░ ржЯрж╛ржЗржк ржХржо ржХрж░рждрзЗ рж╣рзЯ ржУ рзи, ржлрзЗржЗрж╕ржмрзБржХ рж╢рзЗрзЯрж╛рж░рзЗрж░ рж╕ржорзЯрзЗ ржЖржЧрзЗрж░ ржкрзЛрж╕рзНржЯржЯрж┐ рж╕рзНржХрзНрж░рзАржирж╢ржЯ ржЖржХрж╛рж░рзЗ ржерзЗржХрзЗ ржпрж╛рзЯ)

![Screenshot](/img/admin-series-2.png)

ржПржЦржи, ржПржХржЯрж╛ ржЦрзБржмржЗ рж╕рж╣ржЬ рж╕ржорж╛ржзрж╛ржи ржпрж╛ ржЖржорж╛ржжрзЗрж░ ржорж╛ржерж╛рзЯ рж╕ржмрж╛рж░ ржЖржЧрзЗ ржЖрж╕ржмрзЗ рждрж╛ рж╣рж▓ рж░рж┐рж▓рзЗржЯрзЗржб ржирзЗржЗржорзЗрж░ ржмрзНржпржмрж╣рж╛рж░ред ржЕрж░рзНржерж╛рзО `category.product_set.count()` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржПржХрзЗ ржоржбрзЗрж▓рзЗрж░ ржкрзНрж░ржкрж╛рж░рзНржЯрж┐ (ржЕржержмрж╛ ржЕрзНржпрж╛ржбржорж┐ржирзЗрж░ ржорзЗржержб ржпрж╛ ржХрзНржпрж╛ржЯрзЗржЧрж░рж┐ ржЕржмржЬрзЗржХрзНржЯржХрзЗ ржжрзНржмрж┐рждрзАрзЯ ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ рж╣рж┐рж╕рзЗржмрзЗ ржирж┐ржмрзЗ) ржЖржХрж╛рж░рзЗ ржЙржкрж╕рзНржерж╛ржкржи ржХрж░рж╛, ржпрж╛рждрзЗ ржХрж░рзЗ ржЖржкржирж┐ `list_display` рждрзЗ ржПржХрзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░рзЗржиред ржПржЯрж┐ ржЖржкржирж╛ржХрзЗ рж╕ржарж┐ржХ рж░рзЗржЬрж╛рж▓рзНржЯ ржжрж┐ржмрзЗ ржХрж┐ржЫрзБ ржжрзВрж░ ржкрж░рзНржпржирзНржд, ржХрж┐ржирзНрждрзБ ржЖржкржирж┐ рж╕рж░рзНржЯрж┐ржВ ржХрж░ржмрзЗржи ржХрж┐ржнрж╛ржмрзЗ? `N+1` ржкрзНрж░ржмрзНрж▓рзЗржо ржПржХржЯрж╛ ржмрж╛ржЬрзЗ ржЬрж┐ржирж┐рж╕ (рж▓рж┐ржЩрзНржХржЯрж┐ ржкрзЬрж▓рзЗржЗ ржмрзБржЭрждрзЗ ржкрж╛рж░ржмрзЗржи)ред 

ржЖрж░рзЗржХржЯрж╛ рж╕ржорж╛ржзрж╛ржи рж╣рждрзЗ ржкрж╛рж░рзЗ ржпржжрж┐ ржЖржкржирж┐ `Category` ржоржбрзЗрж▓рзЗ `number_of_products` ржжрж┐рзЯрзЗ ржерж╛ржХрзЗржи ржПржмржВ ржкрзНрж░рждрж┐ржмрж╛рж░ `Product` ржЕрзНржпрж╛ржб/ржбрж┐рж▓рж┐ржЯрзЗрж░ рж╕рж╛ржерзЗ рж╕рж╛ржерзЗ ржУржЗ ржлрж┐рж▓рзНржбржЯрж┐ржХрзЗ ржмрж╛рзЬрж╛рждрзЗ/ржХржорж╛рждрзЗ ржерж╛ржХрзЗржиред ржЕржирзНржпрж╛ржирзНржп ржлрж┐рж▓рзНржбрзЗрж░ ржХрзНрж╖рзЗрждрзНрж░рзЗржУ ржПржХрж┐ ржмрзНржпржмрж╕рзНржерж╛ред ржПржЗ рж╕рж▓рзНржпрзБрж╢ржи ржкрзЬрж▓рзЗржЗ ржХрж┐ржирзНрждрзБ ржкрзНрж░ржмрзНрж▓рзЗржо ржкрзНрж░ржмрзНрж▓рзЗржо ржЧржирзНржз ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯред ржХрж╛рж░ржг, `Category` рж╕рзГрж╖рзНржЯрж┐ рж╣ржмрзЗ ржкрзНрж░ржержорзЗ, `Product` ржкрж░ржмрж░рзНрждрж┐рждрзЗ, `Category`-рж░ ржХрж┐ржирзНрждрзБ ржЬрж╛ржирж╛ ржЙржЪрж┐ржд ржирж╛ рждрж╛ржХрзЗ ржХрзЗ ржХрзЗ ржлрж░рзЗржи ржХрзА рж╣рж┐рж╕рзЗржмрзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗржЫрзЗ, ржХрж╛рж░ржг ржЖржкржирж┐ ржЖржкржирж┐ ржЖржкржирж╛рж░ рж╕ржлрзНржЯржУрзЯрзНржпрж╛рж░ржХрзЗ ржпрждржмрж╛рж░ ржЗржирж╣рзНржпрж╛ржирзНрж╕ ржХрж░ржмрзЗржи рждрждржмрж╛рж░ ржХрж┐ ржЖржкржирж┐ ржкрзНрж░рждрж┐ржЯрж╛ ржкрзНрж░рж╛ржХрзНрждржи ржЯрзЗржмрж┐рж▓рзЗ ржЧрж┐рзЯрзЗ ржЧрж┐рзЯрзЗ ржбрзЗржЯрж╛ржмрзЗржЬ ржЯрзЗржмрж┐рж▓ ржЕрж▓ржЯрж╛рж░ ржХрж░ржмрзЗржи? ржЖрж░ржУ ржмрзЬ ржХржерж╛ рж╣рж▓, ржЖржкржирж╛рж░ ржбрзЗржЗржЯрж╛ржмрзЗржЗржЬ рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░ ржХрж┐ржирзНрждрзБ ржЖржкржирж╛рж░ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢рж╛ржи рж▓ржЬрж┐ржХ ржЕржержмрж╛ ржПржкрж┐ржЖржЗ ржЕржирзБржпрж╛рзЯрзА ржЧржарж┐ржд рж╣ржмрзЗ ржирж╛, ржбрзЗржЗржЯрж╛ржмрзЗржЗржЬ ржПрж░ рж▓ржХрзНрж╖рзНржп, рж╕рзНржХрзЛржк ржУ ржЕржкрзНржЯрзАржорж╛ржЗржЬрзЗрж╢рж╛ржи ржкрзНрж░ржХрзНрж░рж┐рзЯрж╛, ржПржкрж┐ржЖржЗ ржЕржержмрж╛ ржЖржкржирж╛рж░ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢рж╛ржи ржПрж░ рж▓ржХрзНрж╖рзНржп, рж╕рзНржХрзЛржк ржУ ржЕржкрзНржЯрзАржорж╛ржЗржЬрзЗрж╢рж╛ржи ржкрзНрж░ржХрзНрж░рж┐рзЯрж╛ ржерзЗржХрзЗ ржнрж┐ржирзНржи, ржЖржЬржХрзЗрж░ ржПржЗ ржорж╛ржЗржХрзНрж░рзЛрж╕рж╛рж░рзНржнрж┐рж╕рзЗрж░ ржпрзБржЧрзЗ ржПржЯрж┐ ржЖрж░ржУ ржкрзНрж░ржпрзЛржЬрзНржпред ржХрж╛ржЬрзЗржЗ ржПржЗ ржЯрж╛ржЗржкрзЗрж░ рж╕рж▓рзНржпрзБрж╢ржиржХрзЗржУ ржЖржорж┐ ржмрж╛ржж ржжрж┐рзЯрзЗржЫрж┐ред

ржЙржкрж░рзЗрж░ ржжрзБржЯрж┐ рж╕рж▓рзНржпрзБрж╢ржи рж╢рзБржзрзБржорж╛рждрзНрж░ ржПржЗ ржХрзБржЗржЬрзЗрж░ ржЬржирзНржп ржмрж╛ржж ржпрзЗ рждрж╛ ржирзЯ, ржЖржорж┐ рж╕рж╛ржзрж╛рж░ржг ржмрзНржпржмрж╣рж╛рж░рзЗржУ ржирж┐рж░рзБрзОрж╕рж╛рж╣рж┐ржд ржХрж░ржмред ржкрзНрж░ржержоржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ рждржЦржиржЗ ржХрж░ржмрзЗржи ржпржЦржи ржЖржкржирж╛рж░ ржбрзЗржЗржЯрж╛ рж╕рж╛ржЗржЬ ржЫрзЛржЯ ржЕржержмрж╛ ржПржХрзНрж╕ржкрзНрж▓рж░рзЗржЯрж░рж┐ ржкрзНрж░рзЛржЧрзНрж░рж╛ржорж┐ржВ ржХрж░ржЫрзЗржи рж╢рзЗрж▓рзЗред ржХрж┐ржирзНрждрзБ ржкрж░рзЗрж░ржЯрж┐ ржПржХржЯрж╛ ржбрж┐ржЬрж╛ржЗржиржЧржд рж╕ржорж╕рзНржпрж╛ ржпрж╛ ржерзЗржХрзЗ ржЕржмрж╢рзНржпржЗ ржжрзВрж░рзЗ ржерж╛ржХржмрзЗржиред

ржПржмрж╛рж░ ржПржХржЯрж╛ рж╕рж▓рзНржпрзБрж╢ржирзЗ ржЖрж╕рж╛ ржпрж╛ржХред ржХрж┐ржЫрзБ рж╕ржорзЯрзЗрж░ ржЬржирзНржп ржнрзБрж▓рзЗ ржпрж╛ржи ржпрзЗ ржЖржкржирж┐ ржЬрзНржпрж╛ржВржЧрзЛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржЫрзЗржи ржПржмржВ ржоржирзЗ ржХрж░рзБржи ржЖржкржирж┐ ржПржЯрж╛ржХрзЗ рж╕рж┐ржХрзБрзЯрзЗрж▓ ржжрж┐рзЯрзЗ рж╕ржорж╛ржзрж╛ржи ржХрж░ржмрзЗржиред ржЕрж░рзНржерж╛рзО `Category.objects.all()` ржПрж░ ржкржерзЗ ржирж╛ ржЧрж┐рзЯрзЗ `SELECT * FROM Category` ржкрже ржЕржмрж▓ржорзНржмржи ржХрж░ржмрзЗржиред рждрж╛рж╣рж▓рзЗ ржХрж┐ржирзНрждрзБ ржЕрж░рзНржзрзЗржХ ржХрж╛ржЬ рж╣рзЯрзЗ ржпрж╛рзЯред `SELECT name, (SELECT count(*) FROM Product WHERE category_id=c.id) number_of_product FROM Category c` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж▓рзЗ ржХрж┐ржирзНрждрзБ ржЖржкржирж┐ ржкрж╛ржЪрзНржЫрзЗржи ржПрж░ ржПржХржЗ ржХрзБрзЯрзЗрж░рж┐рждрзЗ `Category`-ржХрзЗ рж░рзЗржлрж╛рж░ржХрж╛рж░рж┐ `Product` рж╕ржВржЦрзНржпрж╛, ржпрж╛ `number_of_product` рж╣рж┐рж╕рзЗржмрзЗ ржерж╛ржХржмрзЗред `SELECT name, (SELECT avg(price) FROM Product WHERE category_id=c.id) number_of_product FROM Category c` ржерзЗржХрзЗ ржЖржкржирж┐ ржкрж╛ржмрзЗржи ржЧрзЬ ржорзВрж▓рзНржпред рждрзГрждрзАрзЯржЯрж┐рждрзЗ ржкрж░рзЗ ржЖрж╕рж┐, ржХрж╛рж░ржг рж╕рзЗржЯрж┐рж░ рж╕ржорж╛ржзрж╛ржи ржПржХржЗ ржкржжрзНржзрждрж┐рждрзЗ ржХрж░рж╛ ржЧрзЗрж▓рзЗржУ ржЬрзНржпрж╛ржЩрзНржЧрзЛ ржЕрзНржпрж╛ржбржорж┐ржирзЗрж░ ржЬржирзНржп ржЖржорж╛ржжрзЗрж░ ржХрж┐ржЫрзБ рж╕рж┐ржжрзНржзрж╛ржирзНржд ржирж┐рждрзЗ рж╣ржмрзЗ ржпрж╛рж░ ржЬржирзНржп ржЙржкрж░рзЗрж░ ржжрзБржЯрж┐ржХрзЗ ORM ржП ржирж┐рзЯрзЗ рждрж╛ржжрзЗрж░ ржЕрзНржпрж╛ржбржорж┐ржи ржЗржирзНржЯрзЗржЧрзНрж░рзЗрж╢рж╛ржи ржирж┐рзЯрзЗ ржЖржЧрзЗ ржХржерж╛ ржмрж▓рж╛ ржЬрж░рзБрж░рж┐ред

рждрзЛ ржЖржорж░рж╛ ржирзЗрж╕рзНржЯрзЗржб ржХрзБрзЯрзЗрж░рж┐ ржирж┐рзЯрзЗ ржХрж╛ржЬ ржХрж░рждрзЗ ржЪрж╛ржЪрзНржЫрж┐, рждржмрзЗ ржЬрзНржпрж╛ржЩрзНржЧрзЛрждрзЗред ржпрж╛ рждрж╛рзОржХрзНрж╖ржирж┐ржХржнрж╛ржмрзЗ ржмрзБржЭрж╛ ржпрж╛ржЪрзНржЫрзЗ рждрж╛ рж╣рж▓ `Category.objects.all()` рж╣ржмрзЗ ржорзВрж▓ ржХрзБрзЯрзЗрж░рж┐ред ржПрж░ржкрж░ ржЖржорж╛ржжрзЗрж░ ржПрж░ ржнрзЗрждрж░ annotate ржХрж░рждрзЗ рж╣ржмрзЗ ржирзЗрж╕рзНржЯрзЗржб ржХрзБрзЯрзЗрж░рж┐, ржЕрж░рзНржерж╛рзО `Category.objects.annotate(total=Product.objects.filter(тАж))`ред ржУржЗ ... ржП ржпрж╛ржУрзЯрж╛рж░ ржХржерж╛ `WHERE category_id=c.id` ржЕржВрж╢ `SQL` ржХрзБрзЯрзЗрж░рж┐рж░ред ржЕрж░рзНржерж╛рзО, ржирзЗрж╕рзНржЯрзЗржб ржХрзБрзЯрзЗрж░рж┐ рж░рзЗржлрж╛рж░ ржХрж░ржЫрзЗ ржирзЗрж╕рзНржЯ-ржмрж╣рж┐рж░рзНржнрзБржд ржХрзБрзЯрзЗрж░рж┐рж░ ржХрзЛржи ржорзЗржорзНржмрж╛рж░ржХрзЗред ржЬрзНржпрж╛ржЩрзНржЧрзЛ `ORM` ржПржХрзЗ ржЪрж┐ржиржмрзЗ `OuterRef` рж╣рж┐рж╕рзЗржмрзЗ, ржирж╛ржо рж╢рзБржирзЗржЗ ржмрзБржЭрж╛ ржпрж╛ржЪрзНржЫрзЗ ржпрзЗ ржПрж░ ржХрж╛ржЬ рж╣рж▓ ржпрзЗ ржХрзБрзЯрзЗрж░рж┐ ржПржХрзЗ ржирж┐ржЬрзЗрж░ ржнрзЗрждрж░ ржирж┐рзЯрзЗ ржирж┐ржмрзЗ рждрж╛рж░ рж╕рзНржХрзЛржкрзЗрж░ ржХрж╛ржЙржХрзЗ рж░рзЗржлрж╛рж░ ржХрж░рж╛ред ржХрж╛ржЬрзЗржЗ ржЖржорж╛ржжрзЗрж░ ржЬрзНржпрж╛ржЩрзНржЧрзЛ ржХрзБрзЯрзЗрж░рж┐ ржжрж╛ржБрзЬрж╛рзЯ- `Category.objects.annotate(total=Subquery(Product.objects.filter(category=OuterRef(тАЬpkтАЭ)))`ред рждржмрзЗ ржПржЯрж┐ ржПрж░рж░ ржжрж┐ржмрзЗ ржХрж╛рж░ржг ржЖржкржирж╛рж░ ржПржХржЯрж╛ рж░рзЛ ржПржмржВ ржПржХржЯрж╛ ржХрж▓рж╛ржо ржкрзНрж░рзЯрзЛржЬржи ржирзЗрж╕рзНржЯрзЗржб ржХрзБрзЯрзЗрж░рж┐рж░ ржЬржирзНржпред ржЖрж░ рждрж╛рж░ ржЬржирзНржп ржЖржкржирж╛рж░ ржжрж░ржХрж╛рж░ values ржорзЗржержб ржпрж╛ ржжрж┐рзЯрзЗ ржЖржкржирж┐ ржЖржкржирж╛рж░ ржкрзНрж░рзЯрзЛржЬржи ржоржд рж╕рж┐рж▓рзЗржХрзНржЯ ржХрж░рзЗ ржирж┐ржмрзЗржи ржлрж┐рж▓рзНржбред ржЙржжрж╛рж╣рж░ржгрж╕рзНржмрж░рзВржк `Category.objects.annotate(total=Subquery(Product.objects.filter(category=OuterRef(тАЬpkтАЭ)).values(тАЬcategoryтАЭ).annotate(total=Count(тАЬpkтАЭ)).values(тАЬtotalтАЭ)))`ред ржЕржирзЗржХ ржЭрж╛ржорзЗрж▓рж╛? ржПржХржЯрзБ ржнрзЗржЩрзНржЧрзЗ ржЪрж┐ржирзНрждрж╛ ржХрж░рж▓рзЗ ржмрзБржЭрждрзЗ ржкрж╛рж░ржмрзЗржи ржЖрж╕рж▓рзЗ рждрж╛ ржирж╛ред ржЖржкржирж┐ рж╕рж╛ржмржХрзБрзЯрзЗрж░рж┐ рждрзЗ ржкрзНрж░ржержорзЗ `values(тАЬcategoryтАЭ)` ржПрж░ ржорж╛ржзрзНржпржорзЗ ржХрзНржпрж╛ржЯрзЗржЧрж░рж┐ рж╕рж┐рж▓рзЗржХрзНржЯ ржХрж░рж▓рзЗржи, ржПрж░ржкрж░ `Product` ржП `annotate` ржХрж░рзЗ `Count` ржирж┐рж▓рзЗржи, ржПржмржВ ржПржХржЯрж╛ ржХрж▓рж╛ржо рж░рж┐ржЯрж╛рж░рзНржи ржХрж░рждрзЗ рж╕рзЗржЗ ржХрж▓рж╛ржоржЯрж┐ржХрзЗржЗ рж░рж┐ржЯрж╛рж░рзНржи ржХрж░рж▓рзЗржи, ржпрж╛ ржЖржмрж╛рж░ `annotate` ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ ржорзВрж▓ ржХрзБрзЯрзЗрж░рж┐ ржерзЗржХрзЗред ржЕрждржПржм ржЖржкржирж╛рж░ ржХрзБрзЯрзЗрж░рж┐ ржлрзЗрж░ржд рж░рзЗржЬрж╛рж▓рзНржЯрзЗ `total` ржирж╛ржорзЗ ржПржХржЯрж┐ ржорзЗржорзНржмрж╛рж░ ржерж╛ржХржмрзЗ ржпрж╛ `Category` ржоржбрзЗрж▓рзЗрж░ ржЕржирзНрждрж░рзНржнрзБржХрзНржд Product рж╕ржВржЦрзНржпрж╛ ржкрзНрж░ржжрж░рзНрж╢ржи ржХрж░ржмрзЗред ржЖрж░ ржпржжрж┐ ржЖржкржирж┐ ржПржХрзЗ ржЖржирзБрж╕ржЩрзНржЧрж┐ржХ `ModelAdmin` рж╕рж╛ржмржХрзНрж▓рж╛рж╕рзЗрж░ ржУржнрж╛рж░рж░рж╛ржЗржбржХрзГржд `get_queryset` ржП ржврзБржХрж╛ржи рждрж╛рж╣рж▓рзЗ ржЕрзНржпрж╛ржбржорж┐ржи ржПржХрзЗ рж░рзЗржЬрж┐рж╕рзНржЯрж╛рж░рзНржб Model ржПрж░ ржорзЗржорзНржмрж╛рж░ рж╣рж┐рж╕рзЗржмрзЗ ржЪрж┐ржиржмрзЗ, ржХрж╛ржЬрзЗржЗ ржПржХрзЗ ржЖржкржирж┐ рж╕рж░рзНржЯрзЗрж░ ржЖржУрждрж╛рзЯ ржЖржирждрзЗ ржкрж╛рж░ржмрзЗржи ржпржжрж┐ ржмрж▓рзЗ ржжрж┐ржи `admin_order_field` ржП ржлрж┐рж▓рзНржбрзЗрж░ ржирж╛ржоред ржЖрж░ ржЖржкржирж╛ржХрзЗ рж╕рзЗржЗ total ржорзЗржержбрзЗрж░ рж╕ржоржХржХрзНрж╖ ржПржХржЯрж╛ ржорзЗржержб рж▓рж┐ржЦрждрзЗ рж╣ржмрзЗ `total(self, obj)` рж╣рж┐рж╕рзЗржмрзЗ ржоржбрзЗрж▓ржЕрзНржпрж╛ржбржорж┐ржи ржХрзНрж▓рж╛рж╕рзЗ ржХрж╛рж░ржг рж░рзЗржЬрж┐рж╕рзНржЯрзНрж░рзЗрж╢рж╛ржиржХрж╛рж▓рзАржи рж╕ржорзЯрзЗ `ModelAdmin` ржЬрж╛ржиржд ржирж╛ ржУржЗ ржирждрзБржи ржорзЗржорзНржмрж╛рж░ рж╕ржорзНржкрж░рзНржХрзЗред

ржмрзБржЭрж╛ржЗ ржпрж╛ржЪрзНржЫрзЗ ржЧрзЬ ржорзВрж▓рзНржп ржмрзЗрж░ ржХрж░рждрзЗ ржЖржкржирж╛ржХрзЗ рж▓рж┐ржЦрждрзЗ рж╣ржмрзЗ (ржПржХрж┐ржнрж╛ржмрзЗ) `Category.objects.annotate(total=Subquery(Product.objects.filter(category=OuterRef(тАЬpkтАЭ)).values(тАЬcategoryтАЭ).annotate(avg_price=Avg(тАЬpriceтАЭ)).values(тАЬavg_priceтАЭ)))`ред ржПржжрзЗрж░ржХрзЗ рж╕рзНржЯрж╛ржЗрж▓ ржХрж░рж╛рж░ ржЬржирзНржпрзЗ ржПржжрзЗрж░ ржЖржирзБрж╕ржЩрзНржЧрж┐ржХ ржорзЗржержбржХрзЗ mark_safe ржПрж░ ржорж╛ржзрзНржпржорзЗ ржПржЗржЪржЯрж┐ржПржоржПрж▓ ржжрж┐рзЯрзЗ рж╕рзНржЯрж╛ржЗрж▓ ржжрж┐рждрзЗ ржкрж╛рж░рзЗржиред рж╢рзБржзрзБ ржоржирзЗ ржХрж░рзЗ admin_order_field ржХрзЗ ржПржХржЯрзБ ржЪрж┐ржирж┐рзЯрзЗ ржжрж┐ржи рж╕рж░рзНржЯ ржХрж┐ржнрж╛ржмрзЗ ржХрж░рж╛ рж▓рж╛ржЧржмрзЗред

ржПржмрж╛рж░ ржЖрж╕рж╛ ржпрж╛ржХ рждрзГрждрзАрзЯржЯрж┐ рждрзЗ, ржПржЗржЦрж╛ржирзЗ ржЖржкржирж╛ржХрзЗ ржкрзНрж░ржержо рждрж┐ржиржЯрж┐ ржкрзНрж░ржбрж╛ржХрзНржЯрзЗрж░ ржирж╛ржо ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рждрзЗ рж╣ржмрзЗ, ржХрж┐ржирзНрждрзБ ржмрж▓рзЗржЫрж┐рж▓рж╛ржо ржирж╛ ржпрзЗ ржЖржкржирж┐ рж╕рж╛ржм ржЕрж░рзНржерж╛рзО ржирзЗрж╕рзНржЯрзЗржб ржХрзБрзЯрзЗрж░рж┐рждрзЗ рж╕рж░рзНржмрж╛ржзрж┐ржХ ржПржХржЯрж┐ рж░рзЛ ржУ ржПржХржЯрж┐ ржХрж▓рж╛ржо ржмрзЗрж░ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржи? рждрзЛ ржХрзЗржоржирзЗ ржХрж┐? ржПржХржЯрж╛ рж╕рж▓рзБрж╢рж╛ржи рж╣рждрзЗ ржкрж╛рж░рзЗ, ржЖржкржирж┐ annotate ржПрж░ ржорж╛ржзрзНржпржорзЗ рж╕ржорж╕рзНржд name ржЧрзБрж▓рж┐ржХрзЗ aggregate ржХрж░ржмрзЗржи рж╕рзНржЯрзНрж░рж┐ржВ рж╣рж┐рж╕рзЗржмрзЗ, ржЕрж░рзНржерж╛рзО `Category.objects.annotate(product_names=Subquery(Product.objects.filter(category=OuterRef(тАЬpkтАЭ)).values(тАЬcategoryтАЭ).annotate(names=StringAgg(тАЬnameтАЭ, тАЬ||тАЭ)).values(тАЬnamesтАЭ)))`ред ржЕрж░рзНржерж╛рзО ржЖржорж┐ `||` ржПрж░ ржорж╛ржзрзНржпржорзЗ ржПржжрзЗрж░ржХрзЗ ржЖрж▓рж╛ржжрж╛ ржХрж░рзЗржЫрж┐ ржПржмржВ ржПржжрзЗрж░ ржЦрзБрж▓рзЗ `UL>LI` рждрзЗ ржкрж░рж┐ржгржд ржХрж░ржм ржЖржорж┐ ржЕрзНржпрж╛ржбржорж┐ржи ржорзЗржержбрзЗред рж╕ржорзНржкрзВрж░рзНржи ржХрзЛржб ржжрзЗржЦрж▓рзЗржЗ ржмрзБржЭрждрзЗ ржкрж╛рж░ржмрзЗржи-

```python
@admin.register(Category)
class CategoryAdmin(admin.ModelAdmin):
    list_display = "name", "number_of_products", "product_names", "average_price"
    ordering = "name",
    search_fields = "name", "description",

    def number_of_products(self, obj):
        return obj.total

    number_of_products.admin_order_field = "total"

    def product_names(self, obj):
        html = "<li>{}</li>"
        elems = "".join([html.format(i) for i in sorted(obj.product_names.split("||")[:3])])
        print("\n\n\n" + elems + "\n\n\n")
        return mark_safe(f"<ul>{elems}</ul>")

    product_names.admin_order_field = "product_names"

    def average_price(self, obj):
        res = "<div style='text-align:right; width=100%'>CA${:.2f}</div>".format(obj.average_price)
        return mark_safe(res)

    average_price.admin_order_field = "average_price"

    def get_queryset(self, request):
        return super().get_queryset(self).annotate(
            total=Subquery(Product.objects.filter(category=OuterRef("pk")).values("category").annotate(
                total=Count("pk")).values("total")),
            product_names=Subquery(
                Product.objects.filter(
                    category=OuterRef("pk")).values("category").annotate(names=StringAgg("name", "||")).values("names")
            ),
            average_price=Subquery(
                Product.objects.filter(
                    category=OuterRef("pk")).values("category").annotate(avg_price=Avg("price")).values("avg_price")
            ),
        )
```

рждрзЛ ржПржЦржи ржЖржорж░рж╛ ржжрзЗржЦрждрзЗ ржкрж╛ржЪрзНржЫрж┐ ржХрж┐ ржХрж░рзЗ ржЖржорж╛ржжрзЗрж░ ржХрзБржЗржЬрзЗрж░ рж╕ржорж╛ржзрж╛ржи ржХрж░рж╛ ржпрж╛рзЯред ржПржЦржи ржпрж╛ржУрзЯрж╛рж░ ржЖржЧрзЗ ржХрж┐ржЫрзБ ржХржерж╛ ржмрж▓рзЗ рж░рж╛ржЦржЫрж┐ ржпрж╛ ржЖржорж┐ ржкрж░ржмрж░рзНрждрж┐ ржХрзЛржи ржПржХ ржкрзЛрж╕рзНржЯрзЗ ржЙрж▓рзНрж▓рзЗржЦ ржХрж░ржм (ржирж╛ржУ ржХрж░рждрзЗ ржкрж╛рж░рж┐ рж╕ржорзЯ ржирж╛ ржкрзЗрж▓рзЗ)-

- ржпржжрж┐ ржЖржкржирж╛рж░ ржкрзНрж░ржбрж╛ржХрзНржЯ рж╕ржВржЦрзНржпрж╛ ржмрзЗрж╢рж┐ рж╣рзЯ рждрж╛рж╣рж▓рзЗ? ржорж╛ржирзЗ ржпржжрж┐ рззрзжрзжрзж ржкрзНрж░ржбрж╛ржХрзНржЯ ржерж╛ржХрзЗ рждрж╛рж╣рж▓рзЗ ржХрж┐ рзй ржПрж░ рж▓рж┐ржорж┐ржЯ ржХрзБрзЯрзЗрж░рж┐рждрзЗржЗ ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рж╛ ржнрж╛рж▓ ржирж╛? рждрж╛ ржХрж┐ржнрж╛ржмрзЗ ржХрж░ржмрзЗржи? ржПржЗ рж▓рж┐ржЩрзНржХ ржжрзЗржЦрзЗ ржирж┐рждрзЗ ржкрж╛рж░рзЗржи, ржЖржорж┐ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░ржм рж╕рзЗржЯрж┐ ржирж┐рзЯрзЗ рж▓рзЗржЦрж╛рж░ред
- ржЙржкрж░рзЗрж░ ржХрзБрзЯрзЗрж░рж┐ржЧрзБрж▓рзЛржХрзЗ рж▓рж┐ржЦрж╛рж░ ржЖрж░рзЗржХржЯрж┐ рж╕рж╣ржЬ ржЙржкрж╛рзЯ ржЖржЫрзЗ, ржмрж▓рждрзЗ ржкрж╛рж░ржмрзЗржи ржХрзА? ржЖржорж╛рж░ ржЖрж╕рж▓ ржЙржжрзНржжрзЗрж╢рзНржп ржЫрж┐рж▓ `Subquery` ржУ `OuterRef` ржПрж░ рж╕рж╛ржерзЗ ржкрж░рж┐ржЪрзЯ ржХрж░рж╛ржирзЛрж░ ржХрж┐ржирзНрждрзБ ржЕржирзНржпржнрж╛ржмрзЗ ржПржжрзЗрж░ рж╕ржорж╛ржзрж╛ржи рж╕ржорзНржнржмред ржПржХржЯрж┐ ржЙржжрж╛рж╣рж░ржг ржжрж┐рждрзЗ ржкрж╛рж░рж┐ ржУржЗ рж▓рж╛ржЗржирзЗ- `Category.objects.annotate(total=Count(F(тАЬproductтАЭ)))`ред ржЕржирзНржпржЧрзБрж▓рж┐ ржмрзЗрж░ ржХрж░рзЗ ржирж┐ржи ржПржмржВ `explain` ржорзЗржержбрзЗрж░ ржорж╛ржзрзНржпржорзЗ ржмрзЗрж░ ржХрж░рзБржи ржХрзЛржиржЯрж╛ ржнрж╛рж▓ред
- ржПржЗ ржмржЗржЯрж╛ ржкрж░рзЗ ржирж┐рждрзЗ ржкрж╛рж░рзЗржи, ржЦрзБржм рж╕ржВржХрзНрж╖рж┐ржкрзНрждржнрж╛ржмрзЗ ржПржмржВ рж╕рзБржирзНржжрж░ржнрж╛ржмрзЗ ржЬрж╛ржЩрзНржЧрзЛ ORM ржХрзЗ ржЙржкрж╕рзНржерж╛ржкржи ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ ржХрзЗржЗрж╕ ржмрж╛ржЗ ржХрзЗржЗ ржмрзЗрж╕рж┐рж╕рзЗред
ржЖржкрж╛рждржд ржЖржЬржХрзЗ ржПрждржЯрзБржХрзБ ржерж╛ржХред ржкрж░ржмрж░рзНрждрж┐ рж╕рж┐рж░рж┐ржЬрзЗ ржЕрзНржпрж╛ржбржорж┐ржи ржирж┐рзЯрзЗ ржЖрж░ржУ ржХрж┐ржЫрзБ рж▓рж┐ржЦржмред ржХрж┐ржирзНрждрзБ ржмрзБржЭрждрзЗржЗ ржкрж╛рж░ржЫрзЗржи ржпрзЗ ржЖржорж╛рж░ ржЯржкрж┐ржХрзЗрж░ ржЯрж╛ржЗржЯрзЗрж▓ ржЕрзНржпрж╛ржбржорж┐ржи рж╣рж▓рзЗржУ ржЖржорж┐ рж▓рж┐ржЦржЫрж┐ ржЬрзНржпрж╛ржЩрзНржЧрзЛрж░ ржЕржирзНржпрж╛ржирзНржп ржмрж┐рж╖рзЯ ржирж┐рзЯрзЗ ржУ ржЕрзНржпрж╛ржбржорж┐ржиржХрзЗ рж╢рзБржзрзБржорж╛рждрзНрж░ ржирзЯрзЗржЬ рж░рж┐ржбрж╛ржХрж╢ржи ржорзНржпрж╛ржЯрзЗрж░рж┐рзЯрж╛рж▓ рж╣рж┐рж╕рзЗржмрзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗред ржЖржмрж╛рж░ рж▓рж┐ржЦржм ржХрж┐ржЫрзБржжрж┐ржи ржкрж░ ржПржмржВ рж╣рж┐ржирзНржЯ ржжрж┐рзЯрзЗ рж░рж╛ржЦржЫрж┐- ORM ржХрж┐ржирзНрждрзБ рж╣ржмрзЗ ржкрж░ржмрж░рзНрждрж┐ ржкрзЛрж╕рзНржЯред